<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>G.works ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¯è¦–åŒ– - ã¨ã‚Šå°å±‹</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700;900&family=Share+Tech+Mono&display=swap');
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #ffffff;
    font-family: 'Noto Sans JP', sans-serif;
    overflow: hidden; height: 100vh; width: 100vw;
  }
  canvas { position: absolute; top: 0; left: 0; }
  .header { position: absolute; top: 20px; left: 24px; pointer-events: none; z-index: 10; }
  .logo {
    font-family: 'Share Tech Mono', monospace; font-size: 28px; font-weight: 700;
    color: #1E88E5; letter-spacing: 2px; text-shadow: 0 2px 4px rgba(30,136,229,0.3);
  }
  .subtitle { font-size: 11px; color: #1a1a1a; letter-spacing: 3px; margin-top: 2px; font-weight: 300; }
  .legend { position: absolute; bottom: 24px; left: 24px; display: flex; flex-direction: column; gap: 8px; pointer-events: none; z-index: 10; }
  .legend-item { display: flex; align-items: center; gap: 8px; font-size: 11px; color: #1a1a1a; font-family: 'Share Tech Mono', monospace; }
  .legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
  .stats { position: absolute; top: 20px; right: 24px; text-align: right; font-family: 'Share Tech Mono', monospace; pointer-events: none; z-index: 10; }
  .stat-row { font-size: 11px; color: #1a1a1a; margin-bottom: 4px; }
  .stat-val { color: #FF9800; font-size: 14px; }
  .speed-control { position: absolute; bottom: 24px; right: 24px; display: flex; gap: 8px; align-items: center; z-index: 10; }
  .speed-btn {
    background: rgba(255,152,0,0.1); border: 1px solid rgba(255,152,0,0.3);
    color: #FF9800; padding: 6px 14px; border-radius: 4px; cursor: pointer;
    font-family: 'Share Tech Mono', monospace; font-size: 12px; transition: all 0.2s;
  }
  .speed-btn:hover { background: rgba(255,152,0,0.2); }
  .speed-btn.active { background: rgba(255,152,0,0.3); border-color: #FF9800; box-shadow: 0 2px 8px rgba(255,152,0,0.3); }
</style>
</head>
<body>
<canvas id="bg"></canvas>
<canvas id="torikoya"></canvas>
<canvas id="main"></canvas>

<div class="header">
  <div class="logo">G.works</div>
  <div class="subtitle">NPOæ³•äºº ä¼ä¸‰éƒå•†ä¼š ï¼ æ±‚è²¨æ±‚è»Šãƒãƒƒãƒãƒ³ã‚°</div>
</div>
<div class="stats">
  <div class="stat-row">ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ•° <span class="stat-val" id="stat-torikoya">5</span></div>
  <div class="stat-row">ç·æ‹ ç‚¹æ•° <span class="stat-val" id="stat-bases">0</span></div>
  <div class="stat-row">ãƒãƒƒãƒãƒ³ã‚°å®Œäº† <span class="stat-val" id="stat-match">0</span></div>
  <div class="stat-row">ç¨¼åƒä¸­ãƒˆãƒ©ãƒƒã‚¯ <span class="stat-val" id="stat-trucks">0</span></div>
  <div class="stat-row">ã‚ªãƒ•ã‚¡ãƒ¼ä¸­ <span class="stat-val" id="stat-offers">0</span></div>
</div>
<div class="legend">
  <div class="legend-item"><div class="legend-dot" style="background:#1E88E5;box-shadow:0 0 6px #1E88E5"></div> Tï¼šç©ºããƒˆãƒ©ãƒƒã‚¯</div>
  <div class="legend-item"><div class="legend-dot" style="background:#FF9800;box-shadow:0 0 6px #FF9800"></div> è·ä¸»ã‚ªãƒ•ã‚¡ãƒ¼</div>
  <div class="legend-item"><div class="legend-dot" style="background:#FF9800;box-shadow:0 0 6px #FF9800"></div> ãƒ€ãƒ³ï¼ˆãƒãƒƒãƒãƒ³ã‚°å®Œäº†ï¼‰</div>
  <div class="legend-item"><div class="legend-dot" style="background:#FF9800;box-shadow:0 0 6px #FF9800"></div> ã‚‚ã£ã¨ï¼ˆä¾¡æ ¼äº¤æ¸‰ï¼‰</div>
  <div class="legend-item"><div class="legend-dot" style="background:#a78bfa;box-shadow:0 0 6px #a78bfa"></div> Flying Pallet</div>
  <div class="legend-item"><div class="legend-dot" style="background:rgba(30,136,229,0.3);border:2px solid #1E88E5"></div> ğŸ  ã¨ã‚Šå°å±‹é…é€ã‚¨ãƒªã‚¢</div>
</div>
<div class="speed-control">
  <span style="font-family:'Share Tech Mono';font-size:11px;color:#1a1a1a">é€Ÿåº¦</span>
  <button class="speed-btn active" onclick="setSpeed(1)" id="spd1">Ã—1</button>
  <button class="speed-btn" onclick="setSpeed(2)" id="spd2">Ã—2</button>
  <button class="speed-btn" onclick="setSpeed(3)" id="spd3">Ã—3</button>
</div>

<div id="clickHint" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Noto Sans JP';font-size:16px;color:#FF9800;text-shadow:0 2px 8px rgba(255,152,0,0.4);pointer-events:none;z-index:20;opacity:0;transition:opacity 0.5s;">
  ğŸ’¡ ç”»é¢ã‚’ã‚¯ãƒªãƒƒã‚¯ã§æ‹ ç‚¹ã‚’è¿½åŠ ã§ãã¾ã™
</div>

<script>
const bgCanvas = document.getElementById('bg');
const torikoyaCanvas = document.getElementById('torikoya');
const canvas = document.getElementById('main');
const bgCtx = bgCanvas.getContext('2d');
const tkCtx = torikoyaCanvas.getContext('2d');
const ctx = canvas.getContext('2d');
let W, H;

function resize() {
  W = window.innerWidth; H = window.innerHeight;
  bgCanvas.width = torikoyaCanvas.width = canvas.width = W;
  bgCanvas.height = torikoyaCanvas.height = canvas.height = H;
  drawBg();
}

let SPEED = 1;
function setSpeed(s) {
  SPEED = s;
  ['spd1','spd2','spd3'].forEach((id,i) => document.getElementById(id).classList.toggle('active', i+1===s));
}

const ROADS = [];
function buildRoads() {
  const cols=10, rows=8, px=W/(cols+1), py=H/(rows+1);
  for(let r=0;r<=rows;r++) ROADS.push({x1:0,y1:py*(r+0.5),x2:W,y2:py*(r+0.5)});
  for(let c=0;c<=cols;c++) ROADS.push({x1:px*(c+0.5),y1:0,x2:px*(c+0.5),y2:H});
}

let shippers = [];
let torikoyaGroups = [];

// æ–°ã‚¨ãƒªã‚¢ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ ã•ã‚Œã‚‹ï¼‰
let newArea = {
  name: 'æ–°ã‚¨ãƒªã‚¢',
  shipperIds: [],
  maxShippers: 5,
  color: 'rgba(255,152,0,0.18)',
  borderColor: 'rgba(255,152,0,0.9)',
  joinFlash: 0,
  strength: 0,
};

function buildTorikoyaGroups() {
  // å…¨æ‹ ç‚¹ãƒªã‚¹ãƒˆï¼ˆæœ€çµ‚å½¢ï¼‰
  const finalShipperIds = [
    [0, 1, 7, 12],      // æ±äº¬
    [2, 5, 8, 13],      // åŸ¼ç‰
    [3, 9, 14],         // åƒè‘‰
    [4, 10, 15],        // ç¥å¥ˆå·
    [6, 11, 16, 17],    // ç¾¤é¦¬
  ];

  torikoyaGroups = [
    {
      id: 0,
      name: 'æ±äº¬ã‚¨ãƒªã‚¢',
      shipperIds: [0, 1],  // æœ€åˆã¯2æ‹ ç‚¹
      finalShipperIds: finalShipperIds[0],
      color: 'rgba(30,136,229,0.18)',
      borderColor: 'rgba(30,136,229,0.9)',
      joinFlash: 0, strength: 0,
    },
    {
      id: 1,
      name: 'åŸ¼ç‰ã‚¨ãƒªã‚¢',
      shipperIds: [2, 5],
      finalShipperIds: finalShipperIds[1],
      color: 'rgba(30,136,229,0.18)',
      borderColor: 'rgba(30,136,229,0.9)',
      joinFlash: 0, strength: 0,
    },
    {
      id: 2,
      name: 'åƒè‘‰ã‚¨ãƒªã‚¢',
      shipperIds: [3],
      finalShipperIds: finalShipperIds[2],
      color: 'rgba(30,136,229,0.18)',
      borderColor: 'rgba(30,136,229,0.9)',
      joinFlash: 0, strength: 0,
    },
    {
      id: 3,
      name: 'ç¥å¥ˆå·ã‚¨ãƒªã‚¢',
      shipperIds: [4, 10],
      finalShipperIds: finalShipperIds[3],
      color: 'rgba(30,136,229,0.18)',
      borderColor: 'rgba(30,136,229,0.9)',
      joinFlash: 0, strength: 0,
    },
    {
      id: 4,
      name: 'ç¾¤é¦¬ã‚¨ãƒªã‚¢',
      shipperIds: [6, 11],
      finalShipperIds: finalShipperIds[4],
      color: 'rgba(30,136,229,0.18)',
      borderColor: 'rgba(30,136,229,0.9)',
      joinFlash: 0, strength: 0,
    },
  ];

  // æ‹ ç‚¹ã‚’é †æ¬¡è¿½åŠ ã—ã¦ã„ã
  torikoyaGroups.forEach((tg, i) => {
    const remainingIds = tg.finalShipperIds.filter(id => !tg.shipperIds.includes(id));
    remainingIds.forEach((shipperId, j) => {
      setTimeout(() => {
        tg.shipperIds.push(shipperId);
        tg.joinFlash = 50;
        // æ§ãˆã‚ãªãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
        const sh = shippers.find(s => s.id === shipperId);
        if(sh) {
          for(let k=0; k<2; k++) {
            particles.push(new Particle(sh.x, sh.y, tg.borderColor.split(',')[0].replace('rgba(', 'rgb(') + ')'));
          }
        }
      }, (i * 3000 + j * 2500) / SPEED);
    });
  });
}

function buildShippers() {
  const pos=[
    {x:0.15,y:0.25,name:'æ±äº¬å·¥å ´'},      // æ±äº¬ã‚¨ãƒªã‚¢ - å·¦ä¸Š
    {x:0.22,y:0.45,name:'å“å·å€‰åº«'},      // æ±äº¬ã‚¨ãƒªã‚¢ - å·¦ä¸­
    {x:0.45,y:0.20,name:'ã•ã„ãŸã¾å·¥å ´'},  // åŸ¼ç‰ã‚¨ãƒªã‚¢ - ä¸­å¤®ä¸Š
    {x:0.72,y:0.38,name:'åƒè‘‰æ¸¯'},        // åƒè‘‰ã‚¨ãƒªã‚¢ - å³ä¸­
    {x:0.25,y:0.65,name:'æ¨ªæµœDC'},        // ç¥å¥ˆå·ã‚¨ãƒªã‚¢ - å·¦ä¸­ä¸‹
    {x:0.52,y:0.32,name:'æ‰€æ²¢å·¥å ´'},      // åŸ¼ç‰ã‚¨ãƒªã‚¢ - ä¸­å¤®
    {x:0.62,y:0.12,name:'é«˜å´å·¥å ´'},      // ç¾¤é¦¬ã‚¨ãƒªã‚¢ - å³ä¸Š
    {x:0.12,y:0.50,name:'å¤šæ‘©ã‚»ãƒ³ã‚¿ãƒ¼'},  // æ±äº¬ã‚¨ãƒªã‚¢ - å·¦ä¸­
    {x:0.48,y:0.48,name:'å·è¶ŠDC'},        // åŸ¼ç‰ã‚¨ãƒªã‚¢ - ä¸­å¤®
    {x:0.85,y:0.25,name:'æˆç”°ç©ºæ¸¯'},      // åƒè‘‰ã‚¨ãƒªã‚¢ - å³ä¸Š
    {x:0.32,y:0.75,name:'å·å´HUB'},       // ç¥å¥ˆå·ã‚¨ãƒªã‚¢ - å·¦ä¸‹
    {x:0.72,y:0.08,name:'å‰æ©‹å€‰åº«'},      // ç¾¤é¦¬ã‚¨ãƒªã‚¢ - å³ä¸Š
    {x:0.28,y:0.32,name:'æ–°å®¿DC'},        // æ±äº¬ã‚¨ãƒªã‚¢ - å·¦ä¸Š
    {x:0.42,y:0.58,name:'å¤§å®®HUB'},       // åŸ¼ç‰ã‚¨ãƒªã‚¢ - ä¸­å¤®ä¸‹
    {x:0.78,y:0.65,name:'é¤¨å±±æ¸¯'},        // åƒè‘‰ã‚¨ãƒªã‚¢ - å³ä¸‹
    {x:0.58,y:0.68,name:'ç”ºç”°å·¥å ´'},      // ç¥å¥ˆå·ã‚¨ãƒªã‚¢ - ä¸­å¤®ä¸‹
    {x:0.82,y:0.18,name:'ä¼Šå‹¢å´DC'},      // ç¾¤é¦¬ã‚¨ãƒªã‚¢ - å³ä¸Š
    {x:0.68,y:0.28,name:'ç†Šè°·å€‰åº«'},      // ç¾¤é¦¬ã‚¨ãƒªã‚¢ - å³ä¸­
  ];
  shippers = pos.map((p,i) => ({
    id:i, x:p.x*W, y:p.y*H, name:p.name,
    pulse:Math.random()*Math.PI*2,
    offerTimer:60+i*20+Math.random()*80,
    hasOffer:false, offer:null,
    bidderIds:[], winnerId:null, calloutAlpha:0, danFlash:0,
  }));
}

// ã‚¹ãƒ©ã‚¤ãƒ çŠ¶ã®è¼ªéƒ­æç”»ï¼ˆAæ¡ˆï¼šå€‹åˆ¥è¼ªéƒ­ã‚’ä¿æŒï¼‰
function drawTorikoya(tg) {
  if(tg.joinFlash > 0) tg.joinFlash -= SPEED;

  const points = tg.shipperIds.map(id => shippers.find(s => s.id === id)).filter(Boolean);
  if(points.length === 0) return;

  // é…é€ç¯„å›²ã‚’å¤§ããè¨­å®š
  const padding = 130 + tg.strength * 40;
  
  // 1æ‹ ç‚¹ã®å ´åˆã¯å††å½¢ã§æç”»
  if(points.length === 1) {
    drawSinglePointArea(points[0], padding, tg);
    return;
  }
  
  // 2æ‹ ç‚¹ã®å ´åˆã¯æ¥•å††å½¢ã§æç”»
  if(points.length === 2) {
    drawTwoPointArea(points[0], points[1], padding, tg);
    return;
  }
  
  tkCtx.save();

  // ã‚¹ãƒ©ã‚¤ãƒ å½¢çŠ¶ã‚’æç”»
  drawStableSlimeShape(points, padding, tg);

  tkCtx.restore();

  // åˆ©ç”¨ã§å¼·åŒ–
  if(Math.random() < 0.002 * SPEED) {
    tg.strength = Math.min(1, tg.strength + 0.03);
  }
}

// 1æ‹ ç‚¹ã®å ´åˆã¯å††å½¢ã§æç”»
function drawSinglePointArea(point, padding, tg) {
  tkCtx.save();
  
  const radius = padding + 20;
  
  // æ‹ ç‚¹è¿½åŠ ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
  if(tg.joinFlash > 0) {
    const flashAlpha = (tg.joinFlash / 60) * 0.15;
    tkCtx.beginPath();
    tkCtx.arc(point.x, point.y, radius, 0, Math.PI * 2);
    tkCtx.fillStyle = `rgba(245,166,35,${flashAlpha})`;
    tkCtx.fill();
  }
  
  // é…é€ã‚¨ãƒªã‚¢ã®å¡—ã‚Šï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
  const baseAlpha = 0.25 + tg.strength * 0.2;
  const gradient = tkCtx.createRadialGradient(
    point.x, point.y, 0,
    point.x, point.y, radius
  );
  gradient.addColorStop(0, tg.color.replace('0.12', String(baseAlpha + 0.15)));
  gradient.addColorStop(0.7, tg.color.replace('0.12', String(baseAlpha)));
  gradient.addColorStop(1, tg.color.replace('0.12', '0'));
  tkCtx.fillStyle = gradient;
  tkCtx.beginPath();
  tkCtx.arc(point.x, point.y, radius, 0, Math.PI * 2);
  tkCtx.fill();
  
  // å¤–å‘¨ç·š
  const lineWidth = 2 + tg.strength * 2.5;
  const borderAlpha = 0.65 + tg.strength * 0.2;
  tkCtx.beginPath();
  tkCtx.arc(point.x, point.y, radius, 0, Math.PI * 2);
  tkCtx.strokeStyle = tg.borderColor.replace('0.7', String(borderAlpha));
  tkCtx.lineWidth = lineWidth;
  tkCtx.shadowColor = 'transparent';
  tkCtx.shadowBlur = 0;
  tkCtx.stroke();
  
  // æ‹ ç‚¹ãƒãƒ¼ã‚«ãƒ¼
  tkCtx.beginPath();
  tkCtx.arc(point.x, point.y, 3, 0, Math.PI*2);
  tkCtx.fillStyle = tg.borderColor;
  tkCtx.shadowBlur = 0;
  tkCtx.fill();
  
  // ãƒ©ãƒ™ãƒ«ï¼ˆèƒŒæ™¯ä»˜ãï¼‰
  const labelText = `ğŸ  ${tg.name}`;
  tkCtx.font = `bold 12px 'Noto Sans JP'`;
  tkCtx.textAlign = 'center';
  const labelWidth = tkCtx.measureText(labelText).width;
  const labelPadding = 8;
  // èƒŒæ™¯
  tkCtx.fillStyle = 'rgba(255,255,255,0.95)';
  tkCtx.beginPath();
  tkCtx.roundRect(point.x - labelWidth/2 - labelPadding, point.y - 14, labelWidth + labelPadding*2, 20, 4);
  tkCtx.fill();
  tkCtx.strokeStyle = 'rgba(74,85,104,0.2)';
  tkCtx.lineWidth = 1;
  tkCtx.stroke();
  // æ–‡å­—
  tkCtx.fillStyle = '#1a1a1a';
  tkCtx.shadowBlur = 0;
  tkCtx.fillText(labelText, point.x, point.y);
  
  tkCtx.restore();
  
  // åˆ©ç”¨ã§å¼·åŒ–
  if(Math.random() < 0.002 * SPEED) {
    tg.strength = Math.min(1, tg.strength + 0.03);
  }
}

// 2æ‹ ç‚¹ã®å ´åˆã¯ã‚«ãƒ—ã‚»ãƒ«å‹ï¼ˆ2ã¤ã®å††+é•·æ–¹å½¢ï¼‰ã§æç”»
function drawTwoPointArea(point1, point2, padding, tg) {
  tkCtx.save();
  
  // 2ç‚¹ã®ä¸­å¿ƒ
  const cx = (point1.x + point2.x) / 2;
  const cy = (point1.y + point2.y) / 2;
  
  // 2ç‚¹é–“ã®è§’åº¦
  const dx = point2.x - point1.x;
  const dy = point2.y - point1.y;
  const angle = Math.atan2(dy, dx);
  
  // å††ã®åŠå¾„ï¼ˆå›ºå®šå€¤ã§å¤ªã•ã‚’ä¿è¨¼ï¼‰
  const radius = padding * 0.85;
  
  // æ‹ ç‚¹è¿½åŠ ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
  if(tg.joinFlash > 0) {
    const flashAlpha = (tg.joinFlash / 60) * 0.15;
    drawCapsule(point1.x, point1.y, point2.x, point2.y, radius, tkCtx);
    tkCtx.fillStyle = `rgba(245,166,35,${flashAlpha})`;
    tkCtx.fill();
  }
  
  // é…é€ã‚¨ãƒªã‚¢ã®å¡—ã‚Šï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
  const baseAlpha = 0.25 + tg.strength * 0.2;
  const gradient = tkCtx.createRadialGradient(cx, cy, 0, cx, cy, radius * 2);
  gradient.addColorStop(0, tg.color.replace('0.12', String(baseAlpha + 0.15)));
  gradient.addColorStop(0.7, tg.color.replace('0.12', String(baseAlpha)));
  gradient.addColorStop(1, tg.color.replace('0.12', '0'));
  tkCtx.fillStyle = gradient;
  drawCapsule(point1.x, point1.y, point2.x, point2.y, radius, tkCtx);
  tkCtx.fill();
  
  // å¤–å‘¨ç·š
  const lineWidth = 2 + tg.strength * 2.5;
  const borderAlpha = 0.65 + tg.strength * 0.2;
  drawCapsule(point1.x, point1.y, point2.x, point2.y, radius, tkCtx);
  tkCtx.strokeStyle = tg.borderColor.replace('0.7', String(borderAlpha));
  tkCtx.lineWidth = lineWidth;
  tkCtx.shadowColor = 'transparent';
  tkCtx.shadowBlur = 0;
  tkCtx.stroke();
  
  // æ‹ ç‚¹ãƒãƒ¼ã‚«ãƒ¼
  [point1, point2].forEach(p => {
    tkCtx.beginPath();
    tkCtx.arc(p.x, p.y, 3, 0, Math.PI*2);
    tkCtx.fillStyle = tg.borderColor;
    tkCtx.shadowBlur = 0;
    tkCtx.fill();
  });
  
  // ãƒ©ãƒ™ãƒ«ï¼ˆèƒŒæ™¯ä»˜ãï¼‰
  const labelText = `ğŸ  ${tg.name}`;
  tkCtx.font = `bold 12px 'Noto Sans JP'`;
  tkCtx.textAlign = 'center';
  const labelWidth = tkCtx.measureText(labelText).width;
  const labelPadding = 8;
  // èƒŒæ™¯
  tkCtx.fillStyle = 'rgba(255,255,255,0.95)';
  tkCtx.beginPath();
  tkCtx.roundRect(cx - labelWidth/2 - labelPadding, cy - 14, labelWidth + labelPadding*2, 20, 4);
  tkCtx.fill();
  tkCtx.strokeStyle = 'rgba(74,85,104,0.2)';
  tkCtx.lineWidth = 1;
  tkCtx.stroke();
  // æ–‡å­—
  tkCtx.fillStyle = '#1a1a1a';
  tkCtx.shadowBlur = 0;
  tkCtx.fillText(labelText, cx, cy);
  
  tkCtx.restore();
  
  // åˆ©ç”¨ã§å¼·åŒ–
  if(Math.random() < 0.002 * SPEED) {
    tg.strength = Math.min(1, tg.strength + 0.03);
  }
}

// ã‚«ãƒ—ã‚»ãƒ«å‹ï¼ˆ2ã¤ã®åŠå††+é•·æ–¹å½¢ï¼‰ã‚’æç”»
function drawCapsule(x1, y1, x2, y2, radius, ctx) {
  const dx = x2 - x1;
  const dy = y2 - y1;
  const angle = Math.atan2(dy, dx);
  const dist = Math.sqrt(dx * dx + dy * dy);
  
  ctx.beginPath();
  
  // å§‹ç‚¹ã®åŠå††
  ctx.arc(x1, y1, radius, angle + Math.PI / 2, angle + Math.PI * 3 / 2);
  
  // ä¸Šè¾º
  ctx.lineTo(
    x2 + Math.cos(angle + Math.PI * 3 / 2) * radius,
    y2 + Math.sin(angle + Math.PI * 3 / 2) * radius
  );
  
  // çµ‚ç‚¹ã®åŠå††
  ctx.arc(x2, y2, radius, angle + Math.PI * 3 / 2, angle + Math.PI / 2);
  
  // ä¸‹è¾º
  ctx.lineTo(
    x1 + Math.cos(angle + Math.PI / 2) * radius,
    y1 + Math.sin(angle + Math.PI / 2) * radius
  );
  
  ctx.closePath();
}

function drawStableSlimeShape(points, padding, tg) {
  // ä¸­å¿ƒç‚¹ã‚’è¨ˆç®—
  const center = {
    x: points.reduce((sum, p) => sum + p.x, 0) / points.length,
    y: points.reduce((sum, p) => sum + p.y, 0) / points.length,
  };

  // å„ç‚¹ã‹ã‚‰ä¸­å¿ƒã¸ã®è§’åº¦ã§ã‚½ãƒ¼ãƒˆ
  const sortedPoints = points.slice().sort((a, b) => {
    const angleA = Math.atan2(a.y - center.y, a.x - center.x);
    const angleB = Math.atan2(b.y - center.y, b.x - center.x);
    return angleA - angleB;
  });

  // ã‚ˆã‚Šå®‰å®šã—ãŸè¼ªéƒ­ç‚¹ã®ç”Ÿæˆ
  const smoothPoints = [];
  sortedPoints.forEach((p, i) => {
    const angle = Math.atan2(p.y - center.y, p.x - center.x);
    const dist = Math.sqrt((p.x - center.x)**2 + (p.y - center.y)**2);
    
    // ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¿½åŠ ã—ã¦å¤–å´ã«åºƒã’ã‚‹
    const expandedDist = dist + padding;
    const fx = center.x + Math.cos(angle) * expandedDist;
    const fy = center.y + Math.sin(angle) * expandedDist;
    
    smoothPoints.push({x: fx, y: fy});
  });

  // æ‹ ç‚¹è¿½åŠ ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
  if(tg.joinFlash > 0) {
    const flashAlpha = (tg.joinFlash / 60) * 0.1;
    tkCtx.beginPath();
    drawRoundedPolygon(smoothPoints, 20, tkCtx);
    tkCtx.fillStyle = `rgba(245,166,35,${flashAlpha})`;
    tkCtx.fill();
  }

  // é…é€ã‚¨ãƒªã‚¢ã®å¡—ã‚Šï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
  const baseAlpha = 0.25 + tg.strength * 0.2;
  tkCtx.beginPath();
  drawRoundedPolygon(smoothPoints, 20, tkCtx);
  
  const gradient = tkCtx.createRadialGradient(
    center.x, center.y, 0,
    center.x, center.y, padding * 2
  );
  gradient.addColorStop(0, tg.color.replace('0.12', String(baseAlpha + 0.15)));
  gradient.addColorStop(0.7, tg.color.replace('0.12', String(baseAlpha)));
  gradient.addColorStop(1, tg.color.replace('0.12', '0'));
  tkCtx.fillStyle = gradient;
  tkCtx.fill();

  // å¤–å‘¨ç·šï¼ˆå¼·åŒ–ã§å¤ªããªã‚‹ï¼‰
  tkCtx.beginPath();
  drawRoundedPolygon(smoothPoints, 20, tkCtx);
  const lineWidth = 2 + tg.strength * 2.5;
  const borderAlpha = 0.65 + tg.strength * 0.2;
  tkCtx.strokeStyle = tg.borderColor.replace('0.7', String(borderAlpha));
  tkCtx.lineWidth = lineWidth;
  tkCtx.shadowColor = 'transparent';
  tkCtx.shadowBlur = 0;
  tkCtx.stroke();

  // æ‹ ç‚¹ãƒãƒ¼ã‚«ãƒ¼
  points.forEach(p => {
    tkCtx.beginPath();
    tkCtx.arc(p.x, p.y, 3, 0, Math.PI*2);
    tkCtx.fillStyle = tg.borderColor;
    tkCtx.shadowBlur = 0;
    tkCtx.fill();
  });

  // ãƒ©ãƒ™ãƒ«ï¼ˆèƒŒæ™¯ä»˜ãï¼‰
  const labelText = `ğŸ  ${tg.name}`;
  tkCtx.font = `bold 12px 'Noto Sans JP'`;
  tkCtx.textAlign = 'center';
  const labelWidth = tkCtx.measureText(labelText).width;
  const labelPadding = 8;
  // èƒŒæ™¯
  tkCtx.fillStyle = 'rgba(255,255,255,0.95)';
  tkCtx.beginPath();
  tkCtx.roundRect(center.x - labelWidth/2 - labelPadding, center.y - 14, labelWidth + labelPadding*2, 20, 4);
  tkCtx.fill();
  tkCtx.strokeStyle = 'rgba(74,85,104,0.2)';
  tkCtx.lineWidth = 1;
  tkCtx.stroke();
  // æ–‡å­—
  tkCtx.fillStyle = '#1a1a1a';
  tkCtx.shadowBlur = 0;
  tkCtx.fillText(labelText, center.x, center.y);
}

// ã‚ˆã‚Šå®‰å®šã—ãŸä¸¸ã¿ã®ã‚ã‚‹å¤šè§’å½¢æç”»
function drawRoundedPolygon(points, radius, ctx) {
  if(points.length < 3) {
    points.forEach((p, i) => {
      if(i === 0) ctx.moveTo(p.x, p.y);
      else ctx.lineTo(p.x, p.y);
    });
    ctx.closePath();
    return;
  }

  ctx.moveTo(
    points[0].x + (points[1].x - points[0].x) * 0.5,
    points[0].y + (points[1].y - points[0].y) * 0.5
  );

  for(let i = 0; i < points.length; i++) {
    const p1 = points[i];
    const p2 = points[(i + 1) % points.length];
    const p3 = points[(i + 2) % points.length];
    
    // p1ã‹ã‚‰p2ã¸ã®æ–¹å‘
    const dx1 = p2.x - p1.x;
    const dy1 = p2.y - p1.y;
    const len1 = Math.sqrt(dx1*dx1 + dy1*dy1);
    
    // p2ã‹ã‚‰p3ã¸ã®æ–¹å‘
    const dx2 = p3.x - p2.x;
    const dy2 = p3.y - p2.y;
    const len2 = Math.sqrt(dx2*dx2 + dy2*dy2);
    
    // åˆ¶å¾¡ç‚¹ã®è·é›¢ã‚’èª¿æ•´
    const r = Math.min(radius, len1 * 0.3, len2 * 0.3);
    
    // p2ã®æ‰‹å‰ã®åˆ¶å¾¡ç‚¹
    const cp1x = p2.x - (dx1 / len1) * r;
    const cp1y = p2.y - (dy1 / len1) * r;
    
    // p2ã®å…ˆã®åˆ¶å¾¡ç‚¹
    const cp2x = p2.x + (dx2 / len2) * r;
    const cp2y = p2.y + (dy2 / len2) * r;
    
    ctx.lineTo(cp1x, cp1y);
    ctx.quadraticCurveTo(p2.x, p2.y, cp2x, cp2y);
  }
  
  ctx.closePath();
}

let trucks = [];
let matchCount = 0;
let particles = [], offerRings = [], connections = [];

class BidIcon {
  constructor() {
    this.scale = 0.0; this.offsetY = 0; this.targetY = -38; this.bounce = 0; this.ready = false;
  }
  update(dt) {
    if(!this.ready) {
      this.scale = Math.min(1.15, this.scale + 0.16 * SPEED);
      this.offsetY += (this.targetY - this.offsetY) * 0.18 * SPEED;
      if(this.scale >= 1.1) { this.scale = 1.0; this.ready = true; }
    }
    this.bounce += 0.08 * SPEED;
  }
  draw(cx, cy) {
    const by = this.offsetY + Math.sin(this.bounce) * 2.5;
    ctx.save();
    ctx.translate(cx, cy + by);
    ctx.scale(this.scale, this.scale);
    ctx.shadowColor = 'transparent'; ctx.shadowBlur = 0;
    ctx.beginPath(); ctx.roundRect(-22, -14, 44, 22, 6);
    ctx.fillStyle = 'rgba(255,255,255,0.95)'; ctx.strokeStyle = '#FF9800'; ctx.lineWidth = 1.8;
    ctx.fill(); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(-6, 8); ctx.lineTo(6, 8); ctx.lineTo(0, 16); ctx.closePath();
    ctx.fillStyle = 'rgba(255,255,255,0.95)'; ctx.fill(); ctx.strokeStyle = '#FF9800'; ctx.lineWidth = 1.5; ctx.stroke();
    ctx.shadowBlur = 0; ctx.font = `bold 10px 'Noto Sans JP'`; ctx.fillStyle = '#FF9800'; ctx.textAlign = 'center';
    ctx.fillText('ãƒ“ãƒƒãƒ‰', 0, 1);
    ctx.restore();
  }
}

class Truck {
  constructor(id) {
    this.id = id; this.x = Math.random()*W; this.y = Math.random()*H;
    this.targetX = Math.random()*W; this.targetY = Math.random()*H;
    this.speed = 1.2 + Math.random()*0.8;
    this.state = 'idle'; this.offerId = null; this.cargo = false;
    this.destX = 0; this.destY = 0; this.flashTimer = 0;
    this.label = ''; this.labelTimer = 0;
    this.hasPallet = Math.random()<0.3; this.wanderTimer = 0; this.trail = [];
    this.bidIcon = null; this.danGlow = 0;
  }
  update(dt) {
    const sp = this.speed * SPEED;
    this.trail.push({x:this.x, y:this.y, age:0});
    if(this.trail.length>14) this.trail.shift();
    this.trail.forEach(t=>t.age+=dt*SPEED);
    if(this.bidIcon) { this.bidIcon.update(dt); if(this.state!=='bidding'&&this.state!=='motto') this.bidIcon=null; }
    if(this.danGlow>0) this.danGlow-=dt*SPEED*0.025;
    if(this.labelTimer>0) this.labelTimer-=dt*SPEED;
    if(this.flashTimer>0) this.flashTimer-=dt*SPEED;

    if(this.state==='idle') {
      this.wanderTimer-=dt*SPEED;
      if(this.wanderTimer<=0) {
        this.targetX=80+Math.random()*(W-160); this.targetY=80+Math.random()*(H-160);
        this.wanderTimer=60+Math.random()*120;
      }
      this.moveToward(this.targetX, this.targetY, sp*0.7);
    }
    if(this.state==='bidding') {
      const sh=shippers.find(s=>s.id===this.offerId);
      if(sh) this.moveToward(sh.x, sh.y, sp*1.3);
    }
    if(this.state==='delivering') {
      const dist=this.moveToward(this.destX, this.destY, sp*1.1);
      if(dist<20) {
        this.state='idle'; this.cargo=false; this.hasPallet=false;
        this.label='å®Œäº†'; this.labelTimer=40; this.flashTimer=40;
        matchCount++; document.getElementById('stat-match').textContent=matchCount;
      }
    }
  }
  startBid(shId) { this.state='bidding'; this.offerId=shId; this.bidIcon=new BidIcon(); }
  finalize(shId) {
    const sh=shippers.find(s=>s.id===shId);
    if(sh) { sh.hasOffer=false; sh.offer=null; }
    this.state='delivering'; this.cargo=true; this.bidIcon=null; this.offerId=null;
    this.label='ãƒ€ãƒ³ï¼'; this.labelTimer=90; this.flashTimer=90; this.danGlow=1;
    this.destX=80+Math.random()*(W-160); this.destY=80+Math.random()*(H-160);
    for(let i=0;i<12;i++) particles.push(new Particle(this.x,this.y,'#FF9800'));
    particles.push(new Particle(this.x,this.y-20,'#FF9800','ãƒ€ãƒ³ï¼'));
  }
  moveToward(tx,ty,sp) {
    const dx=tx-this.x, dy=ty-this.y, d=Math.sqrt(dx*dx+dy*dy);
    if(d>2) { this.x+=(dx/d)*Math.min(sp,d); this.y+=(dy/d)*Math.min(sp,d); }
    return d;
  }
  draw() {
    this.trail.forEach((t,i)=>{
      const a=(i/this.trail.length)*0.18*(1-t.age/30);
      if(a>0.01) { ctx.beginPath(); ctx.arc(t.x,t.y,2,0,Math.PI*2); ctx.fillStyle=`rgba(30,136,229,${a})`; ctx.fill(); }
    });
    if(this.danGlow>0) {
      ctx.beginPath(); ctx.arc(this.x,this.y,30*(1-this.danGlow)+8,0,Math.PI*2);
      ctx.strokeStyle=`rgba(255,152,0,${this.danGlow*0.6})`; ctx.lineWidth=2; ctx.stroke();
    }
    if(this.flashTimer>0) {
      const fa=(this.flashTimer/90)*0.25;
      const fc=this.label==='ãƒ€ãƒ³ï¼'?'255,152,0':this.state==='bidding'?'255,152,0':'30,136,229';
      ctx.beginPath(); ctx.arc(this.x,this.y,30*(1-this.flashTimer/90)+8,0,Math.PI*2);
      ctx.fillStyle=`rgba(${fc},${fa})`; ctx.fill();
    }
    const isBidding=this.state==='bidding', isMotto=this.state==='motto', isDan=this.label==='ãƒ€ãƒ³ï¼';
    const color = isDan?'#FF9800': isBidding||isMotto?'#FF9800': this.state==='delivering'?'#1E88E5':'#1E88E5';
    const s = isBidding ? 9 : 7;
    ctx.save(); ctx.shadowColor='transparent'; ctx.shadowBlur=0;
    ctx.fillStyle=color; ctx.beginPath(); ctx.roundRect(this.x-s,this.y-s/2,s*1.5,s,2); ctx.fill();
    ctx.globalAlpha=this.cargo?1:0.6; ctx.fillRect(this.x-s*2.2,this.y-s/2,s*1.4,s); ctx.globalAlpha=1;
    ctx.beginPath(); ctx.arc(this.x-s*1.8,this.y+s/2+1,2.5,0,Math.PI*2); ctx.arc(this.x+s*0.3,this.y+s/2+1,2.5,0,Math.PI*2);
    ctx.fillStyle='#1a1a1a'; ctx.fill();
    if(this.hasPallet) { ctx.fillStyle='#a78bfa'; ctx.shadowColor='#a78bfa'; ctx.fillRect(this.x-s*2.2,this.y-s*0.9,s*1.4,2.5); }
    if(this.cargo&&this.state==='delivering') { ctx.fillStyle='rgba(124,252,0,0.5)'; ctx.fillRect(this.x-s*2.2+2,this.y-s/2+2,s*1.4-4,s-4); }
    ctx.restore();
    ctx.font=`bold 8px 'Share Tech Mono'`; ctx.fillStyle=color; ctx.fillText(`T${this.id+1}`, this.x+s+2, this.y-2);
    if(this.labelTimer>0) {
      const a=Math.min(1,this.labelTimer/20), lc=isDan?'#FF9800':this.label==='å®Œäº†'?'#FF9800':'#FF9800';
      ctx.save(); ctx.globalAlpha=a; ctx.font=`bold 12px 'Noto Sans JP'`;
      ctx.fillStyle=lc; ctx.shadowColor='transparent'; ctx.shadowBlur=0; ctx.fillText(this.label, this.x-18, this.y-30); ctx.restore();
    }
    if(this.bidIcon) this.bidIcon.draw(this.x, this.y-8);
  }
}

function drawCallout(sh) {
  if(!sh.hasOffer && sh.calloutAlpha<=0.01) return;
  if(sh.hasOffer && sh.bidderIds.length>0) sh.calloutAlpha=Math.min(1, sh.calloutAlpha+0.06*SPEED);
  else if(!sh.hasOffer) sh.calloutAlpha=Math.max(0, sh.calloutAlpha-0.04*SPEED);
  if(sh.calloutAlpha<=0.01) return;
  const bidders = sh.bidderIds.map(id=>trucks.find(t=>t.id===id)).filter(Boolean);
  if(bidders.length===0) return;
  const rowH=22, headerH=26, boxW=140, boxH=headerH + bidders.length*rowH + 6;
  const bx=sh.x-boxW/2, by=sh.y-boxH-26;
  ctx.save(); ctx.globalAlpha=sh.calloutAlpha;
  ctx.shadowColor='rgba(255,152,0,0.2)'; ctx.shadowBlur=8;
  ctx.beginPath(); ctx.roundRect(bx,by,boxW,boxH,7);
  ctx.fillStyle='rgba(255,255,255,0.95)'; ctx.strokeStyle='rgba(255,152,0,0.5)'; ctx.lineWidth=1.5; ctx.fill(); ctx.stroke();
  ctx.shadowBlur=0;
  ctx.beginPath(); ctx.moveTo(sh.x-8, by+boxH-1); ctx.lineTo(sh.x+8, by+boxH-1); ctx.lineTo(sh.x, sh.y-14); ctx.closePath();
  ctx.fillStyle='rgba(255,255,255,0.95)'; ctx.fill(); ctx.strokeStyle='rgba(255,152,0,0.5)'; ctx.lineWidth=1.5; ctx.stroke();
  ctx.font=`bold 9px 'Noto Sans JP'`; ctx.fillStyle='#FF9800'; ctx.fillText('ğŸ“‹ ãƒ“ãƒƒãƒ‰ä¸­', bx+10, by+16);
  ctx.beginPath(); ctx.moveTo(bx+6,by+headerH-2); ctx.lineTo(bx+boxW-6,by+headerH-2);
  ctx.strokeStyle='rgba(255,152,0,0.2)'; ctx.lineWidth=1; ctx.stroke();
  bidders.forEach((t,i)=>{
    const ry=by+headerH+i*rowH, isWinner=sh.winnerId===t.id, winnerFlashing=isWinner&&sh.danFlash>0, isMotto=t.state==='motto';
    if(winnerFlashing) {
      const pulse=0.5+0.5*Math.sin(sh.danFlash*0.35);
      ctx.beginPath(); ctx.roundRect(bx+4,ry+1,boxW-8,rowH-2,4);
      ctx.fillStyle=`rgba(255,152,0,${0.2*pulse})`; ctx.strokeStyle=`rgba(255,152,0,${0.8*pulse})`;
      ctx.lineWidth=1.5; ctx.shadowColor='#FF9800'; ctx.shadowBlur=8*pulse; ctx.fill(); ctx.stroke(); ctx.shadowBlur=0;
    } else if(isMotto) { ctx.beginPath(); ctx.roundRect(bx+4,ry+1,boxW-8,rowH-2,4); ctx.fillStyle='rgba(255,152,0,0.15)'; ctx.fill(); }
    ctx.font=`bold 10px 'Share Tech Mono'`; ctx.fillStyle=winnerFlashing?'#FF9800': isMotto?'#FF9800':'#4a5568';
    ctx.fillText(`T${t.id+1}`, bx+12, ry+15);
    const pillText=winnerFlashing?'ãƒ€ãƒ³ï¼': isMotto?'ã‚‚ã£ã¨':'ãƒ“ãƒƒãƒ‰ä¸­';
    const pillColor=winnerFlashing?'rgba(255,152,0,0.2)': isMotto?'rgba(255,152,0,0.2)':'rgba(30,136,229,0.15)';
    const pillBorder=winnerFlashing?'rgba(255,152,0,0.8)': isMotto?'rgba(255,152,0,0.8)':'rgba(30,136,229,0.5)';
    const pillTextColor=winnerFlashing?'#FF9800': isMotto?'#FF9800':'#1E88E5';
    ctx.beginPath(); ctx.roundRect(bx+36,ry+4,56,13,4);
    ctx.fillStyle=pillColor; ctx.strokeStyle=pillBorder; ctx.lineWidth=1; ctx.fill(); ctx.stroke();
    ctx.font=`8px 'Noto Sans JP'`; ctx.fillStyle=pillTextColor; ctx.textAlign='center';
    ctx.fillText(pillText, bx+64, ry+13); ctx.textAlign='left';
    if(winnerFlashing) {
      ctx.font=`bold 13px 'Noto Sans JP'`; ctx.fillStyle='#FF9800';
      ctx.shadowColor='transparent'; ctx.shadowBlur=0; ctx.fillText('âœ“', bx+boxW-20, ry+16);
    }
  });
  ctx.restore();
  if(sh.danFlash>0) sh.danFlash-=1.2*SPEED;
}

class Particle {
  constructor(x,y,color,text) {
    this.x=x; this.y=y; this.color=color; this.text=text||null;
    this.vx=(Math.random()-0.5)*3; this.vy=-2-Math.random()*2;
    this.life=70; this.maxLife=70; this.size=3+Math.random()*3;
  }
  update() { this.x+=this.vx*SPEED; this.y+=this.vy*SPEED; this.life-=SPEED; this.vy+=0.05; }
  draw() {
    const a=this.life/this.maxLife;
    if(this.text) {
      ctx.save(); ctx.globalAlpha=a; ctx.font=`bold 14px 'Noto Sans JP'`;
      ctx.fillStyle=this.color; ctx.shadowColor='transparent'; ctx.shadowBlur=0; ctx.fillText(this.text,this.x,this.y); ctx.restore();
    } else {
      ctx.globalAlpha=a; ctx.beginPath(); ctx.arc(this.x,this.y,this.size*a,0,Math.PI*2);
      ctx.fillStyle=this.color; ctx.fill(); ctx.globalAlpha=1;
    }
  }
}

class OfferRing {
  constructor(x,y) { this.x=x; this.y=y; this.radius=6; this.life=1; }
  update() { this.radius+=1.6*SPEED; this.life-=0.018*SPEED; }
  draw() {
    if(this.life<=0.01) return;
    ctx.beginPath(); ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);
    ctx.strokeStyle=`rgba(255,152,0,${this.life*0.5})`; ctx.lineWidth=1.5; ctx.stroke();
  }
}

class Connection {
  constructor(tx,ty,sx,sy) { this.x1=tx; this.y1=ty; this.x2=sx; this.y2=sy; this.life=1; this.progress=0; }
  update() { this.life-=0.007*SPEED; this.progress=Math.min(1,this.progress+0.04*SPEED); }
  draw() {
    if(this.life<=0.01) return;
    const ex=this.x1+(this.x2-this.x1)*this.progress, ey=this.y1+(this.y2-this.y1)*this.progress;
    ctx.beginPath(); ctx.moveTo(this.x1,this.y1); ctx.lineTo(ex,ey);
    ctx.strokeStyle=`rgba(255,152,0,${this.life*0.5})`; ctx.lineWidth=1.5; ctx.setLineDash([4,5]); ctx.stroke(); ctx.setLineDash([]);
  }
}

function drawBg() {
  bgCtx.fillStyle='#ffffff'; bgCtx.fillRect(0,0,W,H);
  for(let x=40;x<W;x+=50) for(let y=40;y<H;y+=50) {
    bgCtx.beginPath(); bgCtx.arc(x,y,0.8,0,Math.PI*2); bgCtx.fillStyle='rgba(74,85,104,0.15)'; bgCtx.fill();
  }
  bgCtx.strokeStyle='rgba(74,85,104,0.08)'; bgCtx.lineWidth=6;
  ROADS.forEach(r=>{ bgCtx.beginPath(); bgCtx.moveTo(r.x1,r.y1); bgCtx.lineTo(r.x2,r.y2); bgCtx.stroke(); });
  shippers.forEach(sh=>{
    const g=bgCtx.createRadialGradient(sh.x,sh.y,0,sh.x,sh.y,45);
    g.addColorStop(0,'rgba(30,136,229,0.08)'); g.addColorStop(1,'rgba(30,136,229,0)');
    bgCtx.fillStyle=g; bgCtx.beginPath(); bgCtx.arc(sh.x,sh.y,45,0,Math.PI*2); bgCtx.fill();
  });
}

function drawShippers() {
  shippers.forEach(sh=>{
    sh.pulse+=0.03*SPEED;
    const col=sh.hasOffer?'#FF9800':'#1E88E5';
    ctx.save();
    ctx.shadowColor='transparent'; ctx.shadowBlur=0;
    ctx.beginPath(); ctx.arc(sh.x,sh.y,6,0,Math.PI*2);
    ctx.fillStyle=col; ctx.fill(); ctx.strokeStyle=col; ctx.lineWidth=1.5; ctx.stroke();
    ctx.restore();
    const pr=10+Math.sin(sh.pulse)*4;
    ctx.beginPath(); ctx.arc(sh.x,sh.y,pr,0,Math.PI*2);
    ctx.strokeStyle=sh.hasOffer?'rgba(255,152,0,0.4)':'rgba(30,136,229,0.3)'; ctx.lineWidth=0.8; ctx.stroke();
    ctx.font=`8px 'Share Tech Mono'`; ctx.fillStyle='#1a1a1a';
    ctx.fillText(sh.name, sh.x+10, sh.y+3);
  });
}

function updateOffers(dt) {
  shippers.forEach(sh=>{
    if(sh.hasOffer) return;
    sh.offerTimer-=dt*SPEED;
    if(sh.offerTimer>0) return;
    const idleTrucks=trucks.filter(t=>t.state==='idle');
    if(idleTrucks.length===0) { sh.offerTimer=80; return; }
    sh.hasOffer=true; sh.offer={price:Math.floor(20000+Math.random()*80000)};
    sh.offerTimer=160+Math.random()*200;
    sh.bidderIds=[]; sh.winnerId=null; sh.calloutAlpha=0; sh.danFlash=0;
    for(let i=0;i<3;i++) setTimeout(()=>offerRings.push(new OfferRing(sh.x,sh.y)),i*200);
    const bidCount=1+Math.floor(Math.random()*Math.min(3,idleTrucks.length));
    const bidders=idleTrucks.slice(0,bidCount);
    bidders.forEach((t,i)=>{
      setTimeout(()=>{
        if(t.state!=='idle') return;
        t.startBid(sh.id); sh.bidderIds.push(t.id);
        connections.push(new Connection(t.x,t.y,sh.x,sh.y));
      }, i*400/SPEED);
    });
    const delay=(bidders.length*400+2000)/SPEED;
    setTimeout(()=>{
      const active=trucks.filter(t=>t.state==='bidding'&&t.offerId===sh.id);
      if(active.length===0) return;
      const winner=active[Math.floor(Math.random()*active.length)];
      active.forEach(t=>{ if(t!==winner){t.state='idle';t.offerId=null;t.bidIcon=null;} });
      sh.bidderIds=sh.bidderIds.filter(id=>id===winner.id);
      if(Math.random()<0.35) {
        winner.state='motto'; winner.label='ã‚‚ã£ã¨'; winner.labelTimer=100; winner.flashTimer=100;
        particles.push(new Particle(winner.x,winner.y,'#FF9800','ã‚‚ã£ã¨'));
        setTimeout(()=>{
          sh.winnerId=winner.id; sh.danFlash=90; winner.finalize(sh.id);
          setTimeout(()=>{ sh.bidderIds=[]; }, 2000/SPEED);
        }, 1600/SPEED);
      } else {
        sh.winnerId=winner.id; sh.danFlash=90;
        setTimeout(()=>{ winner.finalize(sh.id); setTimeout(()=>{ sh.bidderIds=[]; }, 2000/SPEED); }, 300/SPEED);
      }
    }, delay);
  });
}

function updateStats() {
  document.getElementById('stat-trucks').textContent=trucks.filter(t=>t.state!=='idle').length;
  document.getElementById('stat-offers').textContent=shippers.filter(s=>s.hasOffer).length;
  const totalBases = torikoyaGroups.reduce((sum, tg) => sum + tg.shipperIds.length, 0) + newArea.shipperIds.length;
  document.getElementById('stat-bases').textContent=totalBases;
  // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ•°ï¼ˆæ–°ã‚¨ãƒªã‚¢ãŒã‚ã‚Œã°+1ï¼‰
  const networkCount = 5 + (newArea.shipperIds.length > 0 ? 1 : 0);
  document.getElementById('stat-torikoya').textContent=networkCount;
}

let lastTime=0;
function loop(ts) {
  const dt=Math.min((ts-lastTime)/16,3); lastTime=ts;
  tkCtx.clearRect(0,0,W,H);
  ctx.clearRect(0,0,W,H);

  trucks.forEach(t=>t.update(dt));
  offerRings.forEach(r=>r.update());
  connections.forEach(c=>c.update());
  particles.forEach(p=>p.update());
  updateOffers(dt);

  offerRings=offerRings.filter(r=>r.life>0.01);
  connections=connections.filter(c=>c.life>0.01);
  particles=particles.filter(p=>p.life>0);

  if(Math.random()<0.0008*SPEED) {
    const pt=trucks.filter(t=>t.hasPallet&&t.state==='idle');
    if(pt.length) particles.push(new Particle(pt[0].x,pt[0].y-10,'#a78bfa','PACK'));
  }

  // å€‹åˆ¥ã®ã¨ã‚Šå°å±‹ã‚’æç”»
  torikoyaGroups.forEach(tg=>drawTorikoya(tg));
  // æ–°ã‚¨ãƒªã‚¢ã‚’æç”»
  if(newArea.shipperIds.length > 0) {
    drawTorikoya(newArea);
  }
  connections.forEach(c=>c.draw());
  offerRings.forEach(r=>r.draw());
  trucks.filter(t=>t.state==='delivering').forEach(t=>{
    ctx.beginPath(); ctx.moveTo(t.x,t.y); ctx.lineTo(t.destX,t.destY);
    ctx.strokeStyle='rgba(124,252,0,0.08)'; ctx.setLineDash([3,8]); ctx.lineWidth=1; ctx.stroke(); ctx.setLineDash([]);
  });
  drawShippers();
  shippers.forEach(sh=>drawCallout(sh));
  trucks.forEach(t=>t.draw());
  particles.forEach(p=>p.draw());

  ctx.font=`9px 'Share Tech Mono'`; ctx.fillStyle='rgba(45,55,72,0.4)';
  ctx.fillText('æ‰‹æ•°æ–™ 2.5% (è·ä¸»ã®ã¿) ï¼ é‹é€ä¼šç¤¾: ç„¡æ–™', W/2-100, H-10);

  updateStats();
  requestAnimationFrame(loop);
}

function init() {
  resize(); buildRoads(); buildShippers(); buildTorikoyaGroups();
  for(let i=0;i<12;i++) {
    const t=new Truck(i); t.x=Math.random()*W; t.y=Math.random()*H; t.hasPallet=i<4;
    trucks.push(t);
  }
  
  // åˆå›ãƒ’ãƒ³ãƒˆè¡¨ç¤º
  setTimeout(() => {
    const hint = document.getElementById('clickHint');
    hint.style.opacity = '1';
    setTimeout(() => {
      hint.style.opacity = '0';
    }, 3000);
  }, 1000);
  
  // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  canvas.addEventListener('click', handleCanvasClick);
  
  requestAnimationFrame(loop);
}

// ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¯ãƒªãƒƒã‚¯ã§æ–°æ‹ ç‚¹è¿½åŠ 
function handleCanvasClick(event) {
  // æœ€å¤§æ‹ ç‚¹æ•°ãƒã‚§ãƒƒã‚¯
  if(newArea.shipperIds.length >= newArea.maxShippers) {
    return;
  }
  
  // ã‚¯ãƒªãƒƒã‚¯ä½ç½®ã‚’å–å¾—
  const rect = canvas.getBoundingClientRect();
  const x = event.clientX - rect.left;
  const y = event.clientY - rect.top;
  
  // æ–°ã—ã„shipperã‚’ä½œæˆï¼ˆIDã¯æ—¢å­˜ã®æœ€å¤§å€¤+1ï¼‰
  const newId = shippers.length;
  const newShipper = {
    id: newId,
    x: x,
    y: y,
    name: `æ–°æ‹ ç‚¹${newArea.shipperIds.length + 1}`,
    pulse: Math.random() * Math.PI * 2,
    offerTimer: 60 + Math.random() * 80,
    hasOffer: false,
    offer: null,
    bidderIds: [],
    winnerId: null,
    calloutAlpha: 0,
    danFlash: 0,
  };
  
  shippers.push(newShipper);
  newArea.shipperIds.push(newId);
  newArea.joinFlash = 50;
  
  // æ§ãˆã‚ãªãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
  for(let i=0; i<2; i++) {
    particles.push(new Particle(x, y, 'rgb(255,152,0)'));
  }
}

window.addEventListener('resize',()=>{ resize(); buildShippers(); buildTorikoyaGroups(); });
init();
</script>
</body>
</html>
