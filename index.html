<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>G.works „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÂèØË¶ñÂåñ</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700;900&family=Share+Tech+Mono&display=swap');
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #0a0e1a;
    font-family: 'Noto Sans JP', sans-serif;
    overflow: hidden; height: 100vh; width: 100vw;
  }
  canvas { position: absolute; top: 0; left: 0; }
  .header { position: absolute; top: 20px; left: 24px; pointer-events: none; }
  .logo {
    font-family: 'Share Tech Mono', monospace; font-size: 28px; font-weight: 700;
    color: #f5a623; letter-spacing: 2px; text-shadow: 0 0 20px rgba(245,166,35,0.6);
  }
  .subtitle { font-size: 11px; color: rgba(255,255,255,0.4); letter-spacing: 3px; margin-top: 2px; font-weight: 300; }
  .legend { position: absolute; bottom: 24px; left: 24px; display: flex; flex-direction: column; gap: 8px; pointer-events: none; }
  .legend-item { display: flex; align-items: center; gap: 8px; font-size: 11px; color: rgba(255,255,255,0.5); font-family: 'Share Tech Mono', monospace; }
  .legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
  .stats { position: absolute; top: 20px; right: 24px; text-align: right; font-family: 'Share Tech Mono', monospace; pointer-events: none; }
  .stat-row { font-size: 11px; color: rgba(255,255,255,0.4); margin-bottom: 4px; }
  .stat-val { color: #f5a623; font-size: 14px; }
  .speed-control { position: absolute; bottom: 24px; right: 24px; display: flex; gap: 8px; align-items: center; }
  .speed-btn {
    background: rgba(245,166,35,0.15); border: 1px solid rgba(245,166,35,0.3);
    color: #f5a623; padding: 6px 14px; border-radius: 4px; cursor: pointer;
    font-family: 'Share Tech Mono', monospace; font-size: 12px; transition: all 0.2s;
  }
  .speed-btn:hover { background: rgba(245,166,35,0.3); }
  .speed-btn.active { background: rgba(245,166,35,0.4); border-color: #f5a623; box-shadow: 0 0 10px rgba(245,166,35,0.3); }
</style>
</head>
<body>
<canvas id="bg"></canvas>
<canvas id="main"></canvas>

<div class="header">
  <div class="logo">G.works</div>
  <div class="subtitle">NPOÊ≥ï‰∫∫ ‰ºù‰∏âÈÉéÂïÜ‰ºö Ôºè Ê±ÇË≤®Ê±ÇËªä„Éû„ÉÉ„ÉÅ„É≥„Ç∞</div>
</div>
<div class="stats">
  <div class="stat-row">„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÂÆå‰∫Ü <span class="stat-val" id="stat-match">0</span></div>
  <div class="stat-row">Á®ºÂÉç‰∏≠„Éà„É©„ÉÉ„ÇØ <span class="stat-val" id="stat-trucks">0</span></div>
  <div class="stat-row">„Ç™„Éï„Ç°„Éº‰∏≠ <span class="stat-val" id="stat-offers">0</span></div>
</div>
<div class="legend">
  <div class="legend-item"><div class="legend-dot" style="background:#f5a623;box-shadow:0 0 6px #f5a623"></div> TÔºöÁ©∫„Åç„Éà„É©„ÉÉ„ÇØ</div>
  <div class="legend-item"><div class="legend-dot" style="background:#00d4ff;box-shadow:0 0 6px #00d4ff"></div> Ëç∑‰∏ª„Ç™„Éï„Ç°„Éº</div>
  <div class="legend-item"><div class="legend-dot" style="background:#7cfc00;box-shadow:0 0 6px #7cfc00"></div> „ÉÄ„É≥Ôºà„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÂÆå‰∫ÜÔºâ</div>
  <div class="legend-item"><div class="legend-dot" style="background:#ff6b9d;box-shadow:0 0 6px #ff6b9d"></div> „ÇÇ„Å£„Å®Ôºà‰æ°Ê†º‰∫§Ê∏âÔºâ</div>
  <div class="legend-item"><div class="legend-dot" style="background:#a78bfa;box-shadow:0 0 6px #a78bfa"></div> Flying Pallet</div>
</div>
<div class="speed-control">
  <span style="font-family:'Share Tech Mono';font-size:11px;color:rgba(255,255,255,0.4)">ÈÄüÂ∫¶</span>
  <button class="speed-btn active" onclick="setSpeed(1)" id="spd1">√ó1</button>
  <button class="speed-btn" onclick="setSpeed(2)" id="spd2">√ó2</button>
  <button class="speed-btn" onclick="setSpeed(3)" id="spd3">√ó3</button>
</div>

<script>
const bgCanvas = document.getElementById('bg');
const canvas = document.getElementById('main');
const bgCtx = bgCanvas.getContext('2d');
const ctx = canvas.getContext('2d');
let W, H;

function resize() {
  W = window.innerWidth; H = window.innerHeight;
  bgCanvas.width = canvas.width = W;
  bgCanvas.height = canvas.height = H;
  drawBg();
}

let SPEED = 1;
function setSpeed(s) {
  SPEED = s;
  ['spd1','spd2','spd3'].forEach((id,i) => document.getElementById(id).classList.toggle('active', i+1===s));
}

const ROADS = [];
function buildRoads() {
  const cols=6, rows=5, px=W/(cols+1), py=H/(rows+1);
  for(let r=0;r<=rows;r++) ROADS.push({x1:0,y1:py*(r+0.5),x2:W,y2:py*(r+0.5)});
  for(let c=0;c<=cols;c++) ROADS.push({x1:px*(c+0.5),y1:0,x2:px*(c+0.5),y2:H});
}

let shippers = [];
function buildShippers() {
  const pos=[
    {x:0.18,y:0.25,name:'Êù±‰∫¨Â∑•Â†¥'},{x:0.65,y:0.18,name:'ÂüºÁéâÂÄâÂ∫´'},
    {x:0.82,y:0.55,name:'ÂçÉËëâÊ∏Ø'},{x:0.35,y:0.72,name:'Â∑ùË∂äDC'},
    {x:0.55,y:0.45,name:'Â§ßÂÆÆHUB'},{x:0.12,y:0.62,name:'ÊâÄÊ≤¢Â∑•Â†¥'},
  ];
  shippers = pos.map((p,i) => ({
    id:i, x:p.x*W, y:p.y*H, name:p.name,
    pulse:Math.random()*Math.PI*2,
    offerTimer:60+i*30+Math.random()*80,
    hasOffer:false, offer:null,
    bidderIds:[],   // „Éì„ÉÉ„Éâ‰∏≠„Éà„É©„ÉÉ„ÇØID‰∏ÄË¶ß
    winnerId:null,  // ÈÅ∏„Å∞„Çå„ÅüID
    calloutAlpha:0, // Âêπ„ÅçÂá∫„Åó„Éï„Çß„Éº„Éâ
    danFlash:0,     // „ÉÄ„É≥ÊºîÂá∫„Ç´„Ç¶„É≥„Çø
  }));
}

let trucks = [];
let matchCount = 0;
let particles = [], offerRings = [], connections = [];

// ======== BidIcon ========
class BidIcon {
  constructor() {
    this.scale = 0.0;
    this.offsetY = 0;
    this.targetY = -38;
    this.bounce = 0;
    this.ready = false;
  }
  update(dt) {
    if(!this.ready) {
      this.scale = Math.min(1.15, this.scale + 0.16 * SPEED);
      this.offsetY += (this.targetY - this.offsetY) * 0.18 * SPEED;
      if(this.scale >= 1.1) { this.scale = 1.0; this.ready = true; }
    }
    this.bounce += 0.08 * SPEED;
  }
  draw(cx, cy) {
    const by = this.offsetY + Math.sin(this.bounce) * 2.5;
    ctx.save();
    ctx.translate(cx, cy + by);
    ctx.scale(this.scale, this.scale);

    // Drop shadow
    ctx.shadowColor = '#00d4ff';
    ctx.shadowBlur = 14;

    // Badge
    ctx.beginPath();
    ctx.roundRect(-22, -14, 44, 22, 6);
    ctx.fillStyle = 'rgba(0,30,60,0.95)';
    ctx.strokeStyle = '#00d4ff';
    ctx.lineWidth = 1.8;
    ctx.fill(); ctx.stroke();

    // Tail
    ctx.beginPath();
    ctx.moveTo(-6, 8); ctx.lineTo(6, 8); ctx.lineTo(0, 16);
    ctx.closePath();
    ctx.fillStyle = 'rgba(0,30,60,0.95)';
    ctx.fill();
    ctx.strokeStyle = '#00d4ff'; ctx.lineWidth = 1.5;
    ctx.stroke();

    // Text
    ctx.shadowBlur = 0;
    ctx.font = `bold 10px 'Noto Sans JP'`;
    ctx.fillStyle = '#00d4ff';
    ctx.textAlign = 'center';
    ctx.fillText('„Éì„ÉÉ„Éâ', 0, 1);
    ctx.restore();
  }
}

// ======== Truck ========
class Truck {
  constructor(id) {
    this.id = id;
    this.x = Math.random()*W; this.y = Math.random()*H;
    this.targetX = Math.random()*W; this.targetY = Math.random()*H;
    this.speed = 1.2 + Math.random()*0.8;
    this.state = 'idle'; // idle | bidding | motto | delivering
    this.offerId = null;
    this.cargo = false;
    this.destX = 0; this.destY = 0;
    this.flashTimer = 0;
    this.label = ''; this.labelTimer = 0;
    this.hasPallet = Math.random()<0.3;
    this.wanderTimer = 0;
    this.trail = [];
    this.bidIcon = null;
    this.danGlow = 0;
  }

  update(dt) {
    const sp = this.speed * SPEED;
    this.trail.push({x:this.x, y:this.y, age:0});
    if(this.trail.length>14) this.trail.shift();
    this.trail.forEach(t=>t.age+=dt*SPEED);

    if(this.bidIcon) {
      this.bidIcon.update(dt);
      if(this.state!=='bidding' && this.state!=='motto') this.bidIcon=null;
    }
    if(this.danGlow>0) this.danGlow-=dt*SPEED*0.025;
    if(this.labelTimer>0) this.labelTimer-=dt*SPEED;
    if(this.flashTimer>0) this.flashTimer-=dt*SPEED;

    if(this.state==='idle') {
      this.wanderTimer-=dt*SPEED;
      if(this.wanderTimer<=0) {
        this.targetX=80+Math.random()*(W-160);
        this.targetY=80+Math.random()*(H-160);
        this.wanderTimer=60+Math.random()*120;
      }
      this.moveToward(this.targetX, this.targetY, sp*0.7);
    }

    if(this.state==='bidding') {
      const sh=shippers.find(s=>s.id===this.offerId);
      if(sh) this.moveToward(sh.x, sh.y, sp*1.3);
    }

    if(this.state==='delivering') {
      const dist=this.moveToward(this.destX, this.destY, sp*1.1);
      if(dist<20) {
        this.state='idle'; this.cargo=false; this.hasPallet=false;
        this.label='ÂÆå‰∫Ü'; this.labelTimer=40; this.flashTimer=40;
        matchCount++;
        document.getElementById('stat-match').textContent=matchCount;
      }
    }
  }

  startBid(shId) {
    this.state='bidding'; this.offerId=shId;
    this.bidIcon=new BidIcon();
  }

  finalize(shId) {
    const sh=shippers.find(s=>s.id===shId);
    if(sh) { sh.hasOffer=false; sh.offer=null; }
    this.state='delivering'; this.cargo=true;
    this.bidIcon=null; this.offerId=null;
    this.label='„ÉÄ„É≥ÔºÅ'; this.labelTimer=90; this.flashTimer=90;
    this.danGlow=1;
    this.destX=80+Math.random()*(W-160); this.destY=80+Math.random()*(H-160);
    for(let i=0;i<12;i++) particles.push(new Particle(this.x,this.y,'#7cfc00'));
    particles.push(new Particle(this.x,this.y-20,'#7cfc00','„ÉÄ„É≥ÔºÅ'));
  }

  moveToward(tx,ty,sp) {
    const dx=tx-this.x, dy=ty-this.y, d=Math.sqrt(dx*dx+dy*dy);
    if(d>2) { this.x+=(dx/d)*Math.min(sp,d); this.y+=(dy/d)*Math.min(sp,d); }
    return d;
  }

  draw() {
    // Trail
    this.trail.forEach((t,i)=>{
      const a=(i/this.trail.length)*0.18*(1-t.age/30);
      if(a>0.01) {
        ctx.beginPath(); ctx.arc(t.x,t.y,2,0,Math.PI*2);
        ctx.fillStyle=`rgba(245,166,35,${a})`; ctx.fill();
      }
    });

    // Dan glow ring
    if(this.danGlow>0) {
      ctx.beginPath(); ctx.arc(this.x,this.y,30*(1-this.danGlow)+8,0,Math.PI*2);
      ctx.strokeStyle=`rgba(124,252,0,${this.danGlow*0.9})`; ctx.lineWidth=3; ctx.stroke();
    }

    // Flash halo
    if(this.flashTimer>0) {
      const fa=(this.flashTimer/90)*0.35;
      const fc=this.label==='„ÉÄ„É≥ÔºÅ'?'124,252,0':this.state==='bidding'?'0,212,255':'245,166,35';
      ctx.beginPath(); ctx.arc(this.x,this.y,30*(1-this.flashTimer/90)+8,0,Math.PI*2);
      ctx.fillStyle=`rgba(${fc},${fa})`; ctx.fill();
    }

    const isBidding=this.state==='bidding';
    const isMotto=this.state==='motto';
    const isDan=this.label==='„ÉÄ„É≥ÔºÅ';
    const color = isDan?'#7cfc00': isBidding||isMotto?'#00d4ff': this.state==='delivering'?'#f5a623':'#f5a623';
    const s = isBidding ? 10 : 8;

    ctx.save();
    ctx.shadowColor=color; ctx.shadowBlur=isBidding?18:10;
    ctx.fillStyle=color;
    ctx.beginPath(); ctx.roundRect(this.x-s,this.y-s/2,s*1.5,s,2); ctx.fill();
    ctx.globalAlpha=this.cargo?1:0.6;
    ctx.fillRect(this.x-s*2.2,this.y-s/2,s*1.4,s);
    ctx.globalAlpha=1;
    ctx.beginPath();
    ctx.arc(this.x-s*1.8,this.y+s/2+1,3,0,Math.PI*2);
    ctx.arc(this.x+s*0.3,this.y+s/2+1,3,0,Math.PI*2);
    ctx.fillStyle='#1a1a2e'; ctx.fill();
    if(this.hasPallet) {
      ctx.fillStyle='#a78bfa'; ctx.shadowColor='#a78bfa';
      ctx.fillRect(this.x-s*2.2,this.y-s*0.9,s*1.4,3);
    }
    if(this.cargo&&this.state==='delivering') {
      ctx.fillStyle='rgba(124,252,0,0.5)';
      ctx.fillRect(this.x-s*2.2+2,this.y-s/2+2,s*1.4-4,s-4);
    }
    ctx.restore();

    ctx.font=`bold 9px 'Share Tech Mono'`;
    ctx.fillStyle=color;
    ctx.fillText(`T${this.id+1}`, this.x+s+3, this.y-2);

    if(this.labelTimer>0) {
      const a=Math.min(1,this.labelTimer/20);
      const lc=isDan?'#7cfc00':this.label==='ÂÆå‰∫Ü'?'#7cfc00':'#f5a623';
      ctx.save(); ctx.globalAlpha=a;
      ctx.font=`bold 13px 'Noto Sans JP'`;
      ctx.fillStyle=lc; ctx.shadowColor=lc; ctx.shadowBlur=16;
      ctx.fillText(this.label, this.x-20, this.y-34);
      ctx.restore();
    }

    if(this.bidIcon) this.bidIcon.draw(this.x, this.y-8);
  }
}

// ======== CalloutÔºàËç∑‰∏ª„ÅÆÂêπ„ÅçÂá∫„ÅóÔºâ ========
function drawCallout(sh) {
  if(!sh.hasOffer && sh.calloutAlpha<=0.01) return;

  // Alpha animation
  if(sh.hasOffer && sh.bidderIds.length>0) {
    sh.calloutAlpha=Math.min(1, sh.calloutAlpha+0.06*SPEED);
  } else if(!sh.hasOffer) {
    sh.calloutAlpha=Math.max(0, sh.calloutAlpha-0.04*SPEED);
  }
  if(sh.calloutAlpha<=0.01) return;

  const bidders = sh.bidderIds.map(id=>trucks.find(t=>t.id===id)).filter(Boolean);
  if(bidders.length===0) return;

  const rowH=24, headerH=28;
  const boxW=148, boxH=headerH + bidders.length*rowH + 6;
  const bx=sh.x-boxW/2, by=sh.y-boxH-28;

  ctx.save();
  ctx.globalAlpha=sh.calloutAlpha;

  // Shadow/glow
  ctx.shadowColor='#00d4ff'; ctx.shadowBlur=16;

  // Box
  ctx.beginPath(); ctx.roundRect(bx,by,boxW,boxH,7);
  ctx.fillStyle='rgba(3,12,30,0.96)';
  ctx.strokeStyle='rgba(0,212,255,0.75)'; ctx.lineWidth=1.5;
  ctx.fill(); ctx.stroke();

  // Callout tail
  ctx.shadowBlur=0;
  ctx.beginPath();
  ctx.moveTo(sh.x-8, by+boxH-1);
  ctx.lineTo(sh.x+8, by+boxH-1);
  ctx.lineTo(sh.x, sh.y-16);
  ctx.closePath();
  ctx.fillStyle='rgba(3,12,30,0.96)'; ctx.fill();
  ctx.strokeStyle='rgba(0,212,255,0.65)'; ctx.lineWidth=1.5; ctx.stroke();

  // Header
  ctx.font=`bold 10px 'Noto Sans JP'`;
  ctx.fillStyle='#00d4ff';
  ctx.fillText('üìã  „Éì„ÉÉ„Éâ‰∏≠„ÅÆ„Éà„É©„ÉÉ„ÇØ', bx+10, by+17);

  // Divider
  ctx.beginPath(); ctx.moveTo(bx+6,by+headerH-2); ctx.lineTo(bx+boxW-6,by+headerH-2);
  ctx.strokeStyle='rgba(0,212,255,0.25)'; ctx.lineWidth=1; ctx.stroke();

  // Rows
  bidders.forEach((t,i)=>{
    const ry=by+headerH+i*rowH;
    const isWinner=sh.winnerId===t.id;
    const winnerFlashing=isWinner&&sh.danFlash>0;
    const isMotto=t.state==='motto';

    // Row highlight
    if(winnerFlashing) {
      const pulse=0.5+0.5*Math.sin(sh.danFlash*0.35);
      ctx.beginPath(); ctx.roundRect(bx+4,ry+1,boxW-8,rowH-2,4);
      ctx.fillStyle=`rgba(124,252,0,${0.3*pulse})`;
      ctx.strokeStyle=`rgba(124,252,0,${0.9*pulse})`;
      ctx.lineWidth=1.5;
      ctx.shadowColor='#7cfc00'; ctx.shadowBlur=10*pulse;
      ctx.fill(); ctx.stroke(); ctx.shadowBlur=0;
    } else if(isMotto) {
      ctx.beginPath(); ctx.roundRect(bx+4,ry+1,boxW-8,rowH-2,4);
      ctx.fillStyle='rgba(255,107,157,0.12)';
      ctx.fill();
    }

    // T id
    ctx.font=`bold 11px 'Share Tech Mono'`;
    ctx.fillStyle=winnerFlashing?'#7cfc00': isMotto?'#ff6b9d':'#f5a623';
    ctx.fillText(`T${t.id+1}`, bx+12, ry+16);

    // Status pill
    const pillText=winnerFlashing?'„ÉÄ„É≥ÔºÅ': isMotto?'„ÇÇ„Å£„Å®':'„Éì„ÉÉ„Éâ‰∏≠';
    const pillColor=winnerFlashing?'rgba(124,252,0,0.18)': isMotto?'rgba(255,107,157,0.18)':'rgba(0,212,255,0.1)';
    const pillBorder=winnerFlashing?'rgba(124,252,0,0.8)': isMotto?'rgba(255,107,157,0.7)':'rgba(0,212,255,0.4)';
    const pillTextColor=winnerFlashing?'#7cfc00': isMotto?'#ff6b9d':'rgba(0,212,255,0.85)';

    ctx.beginPath(); ctx.roundRect(bx+38,ry+5,60,14,4);
    ctx.fillStyle=pillColor; ctx.strokeStyle=pillBorder; ctx.lineWidth=1;
    ctx.fill(); ctx.stroke();
    ctx.font=`9px 'Noto Sans JP'`;
    ctx.fillStyle=pillTextColor; ctx.textAlign='center';
    ctx.fillText(pillText, bx+68, ry+15);
    ctx.textAlign='left';

    // Checkmark winner
    if(winnerFlashing) {
      ctx.font=`bold 14px 'Noto Sans JP'`; ctx.fillStyle='#7cfc00';
      ctx.shadowColor='#7cfc00'; ctx.shadowBlur=8;
      ctx.fillText('‚úì', bx+boxW-22, ry+17);
      ctx.shadowBlur=0;
    }
  });

  ctx.restore();

  // Tick dan flash down
  if(sh.danFlash>0) sh.danFlash-=1.2*SPEED;
}

// ======== Particles ========
class Particle {
  constructor(x,y,color,text) {
    this.x=x; this.y=y; this.color=color; this.text=text||null;
    this.vx=(Math.random()-0.5)*3; this.vy=-2-Math.random()*2;
    this.life=70; this.maxLife=70; this.size=3+Math.random()*3;
  }
  update() { this.x+=this.vx*SPEED; this.y+=this.vy*SPEED; this.life-=SPEED; this.vy+=0.05; }
  draw() {
    const a=this.life/this.maxLife;
    if(this.text) {
      ctx.save(); ctx.globalAlpha=a;
      ctx.font=`bold 15px 'Noto Sans JP'`;
      ctx.fillStyle=this.color; ctx.shadowColor=this.color; ctx.shadowBlur=14;
      ctx.fillText(this.text,this.x,this.y); ctx.restore();
    } else {
      ctx.globalAlpha=a; ctx.beginPath(); ctx.arc(this.x,this.y,this.size*a,0,Math.PI*2);
      ctx.fillStyle=this.color; ctx.fill(); ctx.globalAlpha=1;
    }
  }
}

class OfferRing {
  constructor(x,y) { this.x=x; this.y=y; this.radius=6; this.life=1; }
  update() { this.radius+=1.6*SPEED; this.life-=0.018*SPEED; }
  draw() {
    if(this.life<=0.01) return;
    ctx.beginPath(); ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);
    ctx.strokeStyle=`rgba(0,212,255,${this.life*0.65})`; ctx.lineWidth=2; ctx.stroke();
  }
}

class Connection {
  constructor(tx,ty,sx,sy) { this.x1=tx; this.y1=ty; this.x2=sx; this.y2=sy; this.life=1; this.progress=0; }
  update() { this.life-=0.007*SPEED; this.progress=Math.min(1,this.progress+0.04*SPEED); }
  draw() {
    if(this.life<=0.01) return;
    const ex=this.x1+(this.x2-this.x1)*this.progress, ey=this.y1+(this.y2-this.y1)*this.progress;
    ctx.beginPath(); ctx.moveTo(this.x1,this.y1); ctx.lineTo(ex,ey);
    ctx.strokeStyle=`rgba(0,212,255,${this.life*0.5})`; ctx.lineWidth=1.5;
    ctx.setLineDash([4,5]); ctx.stroke(); ctx.setLineDash([]);
  }
}

function drawBg() {
  bgCtx.fillStyle='#0a0e1a'; bgCtx.fillRect(0,0,W,H);
  for(let x=40;x<W;x+=60) for(let y=40;y<H;y+=60) {
    bgCtx.beginPath(); bgCtx.arc(x,y,1,0,Math.PI*2);
    bgCtx.fillStyle='rgba(255,255,255,0.04)'; bgCtx.fill();
  }
  bgCtx.strokeStyle='rgba(255,255,255,0.035)'; bgCtx.lineWidth=8;
  ROADS.forEach(r=>{ bgCtx.beginPath(); bgCtx.moveTo(r.x1,r.y1); bgCtx.lineTo(r.x2,r.y2); bgCtx.stroke(); });
  shippers.forEach(sh=>{
    const g=bgCtx.createRadialGradient(sh.x,sh.y,0,sh.x,sh.y,55);
    g.addColorStop(0,'rgba(245,166,35,0.07)'); g.addColorStop(1,'rgba(245,166,35,0)');
    bgCtx.fillStyle=g; bgCtx.beginPath(); bgCtx.arc(sh.x,sh.y,55,0,Math.PI*2); bgCtx.fill();
  });
}

function drawShippers() {
  shippers.forEach(sh=>{
    sh.pulse+=0.03*SPEED;
    const col=sh.hasOffer?'#00d4ff':'rgba(245,166,35,0.5)';
    ctx.save();
    ctx.shadowColor=col; ctx.shadowBlur=sh.hasOffer?22:8;
    ctx.beginPath(); ctx.arc(sh.x,sh.y,8,0,Math.PI*2);
    ctx.fillStyle=col; ctx.fill(); ctx.strokeStyle=col; ctx.lineWidth=2; ctx.stroke();
    ctx.restore();
    const pr=12+Math.sin(sh.pulse)*5;
    ctx.beginPath(); ctx.arc(sh.x,sh.y,pr,0,Math.PI*2);
    ctx.strokeStyle=sh.hasOffer?'rgba(0,212,255,0.3)':'rgba(245,166,35,0.15)'; ctx.lineWidth=1; ctx.stroke();
    ctx.font=`10px 'Share Tech Mono'`; ctx.fillStyle='rgba(255,255,255,0.5)';
    ctx.fillText(sh.name, sh.x+12, sh.y+4);
  });
}

// ======== Offer orchestration ========
function updateOffers(dt) {
  shippers.forEach(sh=>{
    if(sh.hasOffer) return;
    sh.offerTimer-=dt*SPEED;
    if(sh.offerTimer>0) return;

    const idleTrucks=trucks.filter(t=>t.state==='idle');
    if(idleTrucks.length===0) { sh.offerTimer=80; return; }

    // Launch offer
    sh.hasOffer=true; sh.offer={price:Math.floor(20000+Math.random()*80000)};
    sh.offerTimer=160+Math.random()*200;
    sh.bidderIds=[]; sh.winnerId=null; sh.calloutAlpha=0; sh.danFlash=0;

    for(let i=0;i<3;i++) setTimeout(()=>offerRings.push(new OfferRing(sh.x,sh.y)),i*200);

    const bidCount=1+Math.floor(Math.random()*Math.min(3,idleTrucks.length));
    const bidders=idleTrucks.slice(0,bidCount);

    // Staggered bids
    bidders.forEach((t,i)=>{
      setTimeout(()=>{
        if(t.state!=='idle') return;
        t.startBid(sh.id);
        sh.bidderIds.push(t.id);
        connections.push(new Connection(t.x,t.y,sh.x,sh.y));
      }, i*400/SPEED);
    });

    // After bids settle ‚Üí pick winner ‚Üí dan
    const delay=(bidders.length*400+2000)/SPEED;
    setTimeout(()=>{
      const active=trucks.filter(t=>t.state==='bidding'&&t.offerId===sh.id);
      if(active.length===0) return;

      const winner=active[Math.floor(Math.random()*active.length)];
      // Losers idle
      active.forEach(t=>{ if(t!==winner){t.state='idle';t.offerId=null;t.bidIcon=null;} });
      sh.bidderIds=sh.bidderIds.filter(id=>id===winner.id);

      // „ÇÇ„Å£„Å® (35%)
      if(Math.random()<0.35) {
        winner.state='motto'; winner.label='„ÇÇ„Å£„Å®'; winner.labelTimer=100; winner.flashTimer=100;
        particles.push(new Particle(winner.x,winner.y,'#ff6b9d','„ÇÇ„Å£„Å®'));
        setTimeout(()=>{
          sh.winnerId=winner.id; sh.danFlash=90;
          winner.finalize(sh.id);
          setTimeout(()=>{ sh.bidderIds=[]; }, 2000/SPEED);
        }, 1600/SPEED);
      } else {
        sh.winnerId=winner.id; sh.danFlash=90;
        setTimeout(()=>{
          winner.finalize(sh.id);
          setTimeout(()=>{ sh.bidderIds=[]; }, 2000/SPEED);
        }, 300/SPEED);
      }
    }, delay);
  });
}

function updateStats() {
  document.getElementById('stat-trucks').textContent=trucks.filter(t=>t.state!=='idle').length;
  document.getElementById('stat-offers').textContent=shippers.filter(s=>s.hasOffer).length;
}

let lastTime=0;
function loop(ts) {
  const dt=Math.min((ts-lastTime)/16,3); lastTime=ts;
  ctx.clearRect(0,0,W,H);

  trucks.forEach(t=>t.update(dt));
  offerRings.forEach(r=>r.update()); connections.forEach(c=>c.update()); particles.forEach(p=>p.update());
  updateOffers(dt);

  offerRings=offerRings.filter(r=>r.life>0.01);
  connections=connections.filter(c=>c.life>0.01);
  particles=particles.filter(p=>p.life>0);

  if(Math.random()<0.0008*SPEED) {
    const pt=trucks.filter(t=>t.hasPallet&&t.state==='idle');
    if(pt.length) particles.push(new Particle(pt[0].x,pt[0].y-10,'#a78bfa','PACK'));
  }

  connections.forEach(c=>c.draw()); offerRings.forEach(r=>r.draw());

  trucks.filter(t=>t.state==='delivering').forEach(t=>{
    ctx.beginPath(); ctx.moveTo(t.x,t.y); ctx.lineTo(t.destX,t.destY);
    ctx.strokeStyle='rgba(124,252,0,0.1)'; ctx.setLineDash([3,8]); ctx.lineWidth=1; ctx.stroke(); ctx.setLineDash([]);
  });

  drawShippers();
  shippers.forEach(sh=>drawCallout(sh));   // Âêπ„ÅçÂá∫„ÅóÔºà„Éà„É©„ÉÉ„ÇØ„ÅÆ‰∏ã„Å´ÊèèÁîªÔºâ
  trucks.forEach(t=>t.draw());             // „Éà„É©„ÉÉ„ÇØÔºàÂêπ„ÅçÂá∫„Åó„ÅÆ‰∏äÔºâ
  particles.forEach(p=>p.draw());

  ctx.font=`10px 'Share Tech Mono'`; ctx.fillStyle='rgba(245,166,35,0.18)';
  ctx.fillText('ÊâãÊï∞Êñô 2.5% (Ëç∑‰∏ª„ÅÆ„Åø) Ôºè ÈÅãÈÄÅ‰ºöÁ§æ: ÁÑ°Êñô', W/2-110, H-10);

  updateStats();
  requestAnimationFrame(loop);
}

function init() {
  resize(); buildRoads(); buildShippers();
  for(let i=0;i<8;i++) {
    const t=new Truck(i);
    t.x=Math.random()*W; t.y=Math.random()*H; t.hasPallet=i<3;
    trucks.push(t);
  }
  requestAnimationFrame(loop);
}

window.addEventListener('resize',()=>{ resize(); buildShippers(); });
init();
</script>
</body>
</html>